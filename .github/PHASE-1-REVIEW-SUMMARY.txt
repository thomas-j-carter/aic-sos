================================================================================
PHASE-1 REVIEW: CONTROL PLANE MULTI-TENANCY & IDENTITY
================================================================================

Status: âœ… REVIEWED & UNDERSTOOD
Date: December 19, 2024
Reviewer: GitHub Copilot

================================================================================
QUICK SUMMARY
================================================================================

PHASE-1 is the critical foundation for the entire platform. It establishes:
- Multi-tenant data isolation (tenants â†” workspaces)
- User identity & authentication (OIDC + JWT)
- Authorization rules (RBAC with 5 roles)
- Data residency compliance (US/EU region pinning)
- Privacy defaults (metadata-only mode)
- Provider key management (BYO LLM keys)

Exit Gate: Create tenant â†’ log in â†’ store keys â†’ publish workflow â†’ list with isolation

================================================================================
PHASE-1 P0 TASKS (6 CRITICAL)
================================================================================

Task 1: DATA MODEL + MIGRATIONS
  Status: Schema exists (schema.sql), migrations needed
  Effort: 4-6 hours
  Blocker: All other tasks depend on this
  Tables: tenants, workspaces, users, roles, workflows, runs, audit_events
  
Task 2: IDENTITY (OIDC LOGIN + SERVICE AUTH)
  Status: Not implemented
  Effort: 6-8 hours
  Requires: OIDC provider (Auth0/Okta/mock), JWT middleware
  Deliverable: Web UI login, API key endpoints, principal context on calls

Task 3: AUTHORIZATION (RBAC)
  Status: Schema exists (roles table), logic not implemented
  Effort: 4-5 hours
  Requires: Task 2 (identity/principal_id)
  Roles: WorkspaceAdmin, Operator, Approver, Auditor (read-only), IntegrationAdmin

Task 4: REGION PINNING (US/EU)
  Status: Schema has region field, enforcement not implemented
  Effort: 3-4 hours
  Requires: Task 1 (workspace.region), Task 2 (middleware)
  Deliverable: Cross-region calls blocked, US/EU isolation enforced

Task 5: TENANT DATA MODE (METADATA-ONLY DEFAULT)
  Status: Not implemented
  Effort: 2-3 hours
  Requires: Task 1 (workspace_config), execution-plane awareness
  Deliverable: Config flag controls content persistence

Task 6: BYO PROVIDER KEYS (OPENAI/AZURE/ANTHROPIC)
  Status: Schema exists (provider_keys table), encryption/validation needed
  Effort: 4-6 hours
  Requires: Task 1 (provider_keys table), KMS setup, validation logic
  Deliverable: Store encrypted, validate on entry, rotate without downtime

Task 7: PUBLIC API SURFACE
  Status: Schema/stubs exist, handlers not implemented
  Effort: 4-5 hours
  Requires: Task 2 (auth), Task 3 (rbac), Task 6 (keys)
  Endpoints: 13+ REST endpoints (tenant/workspace CRUD, workflow publish, key management)

================================================================================
RECOMMENDED IMPLEMENTATION ORDER
================================================================================

1. Database Migrations (Task 1)         â†’ Start here, blocks all tasks
2. OIDC + JWT Middleware (Task 2)       â†’ Needed for auth on endpoints
3. RBAC Authorization (Task 3)          â†’ Depends on Task 2
4. Region Pinning (Task 4)              â†’ Depends on Task 1, 2
5. Data Mode (Task 5)                   â†’ Depends on Task 1
6. BYO Provider Keys (Task 6)           â†’ Depends on Task 1, KMS
7. API Surface (Task 7)                 â†’ Depends on Task 2, 3, 6

================================================================================
KEY TECHNICAL DECISIONS
================================================================================

Database Isolation:
  âœ“ DECISION: App-level scoping (Task 1) for MVP speed
  âœ“ PLAN: Add PostgreSQL RLS in PHASE-2 for production hardening

Data Residency:
  âœ“ DECISION: Single PostgreSQL + RLS rules for MVP (no separate region DBs)
  âœ“ PLAN: Separate region-specific databases in PHASE-2+ if required

OIDC Provider:
  âœ“ DECISION: Use mock OIDC for dev, support Auth0 for testing
  âœ“ PLAN: Customers bring their own IdP (Auth0, Okta, Azure AD)

Encryption:
  âœ“ DECISION: Go crypto package for MVP (local keyfile)
  âœ“ PLAN: Upgrade to AWS KMS / HashiCorp Vault in PHASE-2

================================================================================
EFFORT ESTIMATE
================================================================================

Task 1: Database Migrations           4-6 hours
Task 2: OIDC + JWT                    6-8 hours
Task 3: RBAC                          4-5 hours
Task 4: Region Pinning                3-4 hours
Task 5: Data Mode                     2-3 hours
Task 6: BYO Provider Keys             4-6 hours
Task 7: API Surface                   4-5 hours
                                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL:                               27-37 hours

Calendar Time: 3-5 days (1-2 engineers working in parallel)

================================================================================
EXIT GATE CHECKLIST
================================================================================

The team has succeeded when all of these work:

âœ“ Create tenant (name, region) via API
âœ“ Create workspace (tenant_id, name, region) via API
âœ“ Log in via OIDC (IdP redirects, returns JWT)
âœ“ Store BYO OpenAI key (encrypted, validated)
âœ“ Create workflow (YAML definition)
âœ“ Publish workflow version (immutable)
âœ“ List published workflows via API (filtered by workspace)
âœ“ Verify isolation: User from Workspace B cannot see Workspace A workflows
âœ“ Verify region pinning: US workspace cannot access EU data
âœ“ Web UI displays tenant, workspace, logged-in user

When all above pass â†’ Ready for PHASE-2 (Execution Plane)

================================================================================
KNOWN UNKNOWNS & DECISIONS NEEDED
================================================================================

1. PostgreSQL RLS vs App-Level Scoping?
   â†’ MVP: App-level (easier, faster)
   â†’ Production: RLS (defense in depth)

2. Single DB vs Region-Specific Databases?
   â†’ MVP: Single DB (simpler ops)
   â†’ Scale: Region-specific (true residency)

3. OIDC Provider Selection?
   â†’ Dev: Mock OIDC server
   â†’ Test: Auth0 (easiest to test)
   â†’ Prod: Customer's own IdP

4. Encryption Strategy?
   â†’ MVP: Go crypto + local keyfile
   â†’ Prod: AWS KMS / Vault

================================================================================
EXISTING ARTIFACTS IN REPO
================================================================================

âœ“ docs/todos/02-PHASE-1-Control-Plane-MultiTenancy-and-Identity.md
  â†’ Authoritative source for PHASE-1 requirements

âœ“ db/schema.sql (187 lines)
  â†’ Partial schema, needs completion and migration framework

âœ“ data/entities.md
  â†’ Canonical entity mapping for database

âœ“ data/db-schema.md
  â†’ RLS notes and design rationale

âœ“ contracts/openapi/openapi.yaml
  â†’ OpenAPI schema skeleton (needs endpoint definitions)

âœ“ services/control-plane/main.go (stub)
  â†’ Ready for real implementation

================================================================================
NEXT STEPS
================================================================================

1. MARK AS READY: Task 3 review complete âœ“

2. CONFIRM DECISIONS: 
   - Use app-level scoping? (vs RLS)
   - Mock OIDC for dev? (vs Auth0)
   - Go crypto for encryption? (vs KMS)

3. BEGIN IMPLEMENTATION: Task 4 (Start Milestone 1 - Control Plane P0s)
   â†’ Start with Task 1: Database Migrations

4. MAINTAIN THIS DOCUMENT:
   â†’ Update as implementation progresses
   â†’ Mark completed tasks
   â†’ Track blockers/decisions

================================================================================
KEY FILES
================================================================================

Documentation:
  .github/PHASE-1-REVIEW.md (8000+ words, detailed breakdown)
  .github/PHASE-1-REVIEW-SUMMARY.txt (this file)
  docs/todos/02-PHASE-1-Control-Plane-MultiTenancy-and-Identity.md

Database:
  db/schema.sql (partial schema)
  data/entities.md (entity mapping)
  data/db-schema.md (design notes)

Implementation:
  services/control-plane/main.go (stub, ready for real code)
  contracts/openapi/openapi.yaml (API schema skeleton)

================================================================================
STATUS: READY TO IMPLEMENT
================================================================================

PHASE-1 review is complete. All requirements understood, dependencies mapped,
effort estimated, key decisions identified.

Next Action: Begin Milestone 1 implementation (Task 4)

Start with: Database Migrations (Task 1) â†’ OIDC (Task 2) â†’ RBAC (Task 3) â†’ ...

Timeline: 3-5 calendar days for full PHASE-1 P0 completion

Ready? Let's build the Control Plane! ðŸš€

