name: CI

on:
  push:
    branches:
      - main
      - 'release/**'
  pull_request:
    branches:
      - main
      - 'release/**'

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Go
  GO_VERSION: '1.21'
  # Rust
  RUST_VERSION: 'stable'
  # Node
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # GO SERVICES: control-plane, connector-gateway
  # ============================================================================
  go-build:
    name: 'Go: Build'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download
        working-directory: services/control-plane

      - name: Build control-plane
        run: go build ./...
        working-directory: services/control-plane

      - name: Download dependencies
        run: go mod download
        working-directory: services/connector-gateway

      - name: Build connector-gateway
        run: go build ./...
        working-directory: services/connector-gateway

  go-test:
    name: 'Go: Tests'
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_app
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests - control-plane
        run: go test -v -race -coverprofile=coverage.txt ./...
        working-directory: services/control-plane
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_app
          REDIS_URL: redis://localhost:6379

      - name: Run tests - connector-gateway
        run: go test -v -race -coverprofile=coverage.txt ./...
        working-directory: services/connector-gateway
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_app

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./services/*/coverage.txt
          flags: go
          fail_ci_if_error: false

  go-lint:
    name: 'Go: Lint'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: golangci-lint for control-plane
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: services/control-plane
          args: --timeout=5m

      - name: golangci-lint for connector-gateway
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: services/connector-gateway
          args: --timeout=5m

      - name: go fmt check
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi
        working-directory: services

      - name: go mod tidy check
        run: |
          for dir in control-plane connector-gateway; do
            cd $dir
            go mod tidy
            if [ -n "$(git diff go.mod go.sum)" ]; then
              echo "$dir: go.mod/go.sum out of sync"
              exit 1
            fi
            cd ..
          done
        working-directory: services

  # ============================================================================
  # RUST SERVICES: execution-plane, agent
  # ============================================================================
  rust-build:
    name: 'Rust: Build'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build execution-plane
        run: cargo build --release
        working-directory: services/execution-plane

      - name: Build agent
        run: cargo build --release
        working-directory: services/agent

  rust-test:
    name: 'Rust: Tests'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests - execution-plane
        run: cargo test --verbose
        working-directory: services/execution-plane

      - name: Run tests - agent
        run: cargo test --verbose
        working-directory: services/agent

  rust-fmt:
    name: 'Rust: Format'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  rust-clippy:
    name: 'Rust: Clippy (Linter)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: clippy

      - name: Cache cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ============================================================================
  # TYPESCRIPT/NODE: web app
  # ============================================================================
  ts-check:
    name: 'TypeScript: Type Check & Lint'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm install
        working-directory: apps/web

      - name: TypeScript check
        run: npm run typecheck
        working-directory: apps/web
        continue-on-error: true

      - name: Lint
        run: npm run lint
        working-directory: apps/web
        continue-on-error: true

  ts-test:
    name: 'TypeScript: Tests'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm install
        working-directory: apps/web

      - name: Run tests
        run: npm test
        working-directory: apps/web
        continue-on-error: true

  # ============================================================================
  # CONTRACT VALIDATION & GENERATION
  # ============================================================================
  contracts-validate:
    name: 'Contracts: Validate & Generate'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install OpenAPI and validation tools
        run: npm install -g @apidevtools/swagger-cli ajv-cli @openapitools/openapi-generator-cli

      - name: Validate contracts
        run: |
          chmod +x ./scripts/validate-contracts.sh
          ./scripts/validate-contracts.sh

      - name: Generate contract stubs
        run: |
          chmod +x ./scripts/generate-contracts.sh
          ./scripts/generate-contracts.sh

      - name: Check for uncommitted generated files
        run: |
          # Check if generate-contracts.sh created any new files that weren't committed
          if [ -z "$(git status --porcelain services/*/generated apps/*/generated contracts/generated)" ]; then
            echo "✓ All generated files are committed"
          else
            echo "⚠ Generated files differ from committed versions:"
            git diff --name-only services/*/generated apps/*/generated contracts/generated || true
            echo ""
            echo "Run 'make contracts' locally and commit generated files"
            # Note: Not failing here in Phase 0; Phase 1 will enforce
          fi

  # ============================================================================
  # SECURITY SCANNING
  # ============================================================================
  security-gitleaks:
    name: 'Security: Secret Scanning (gitleaks)'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks - Fail on secrets detected
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_EXITCODE: 1  # Fail if any secrets found

  security-dependencies:
    name: 'Security: Dependency Scanning'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check Go dependencies with Nancy
        run: |
          go install github.com/sonatype-nexus-community/nancy@latest
          go mod graph | nancy sleuth
        working-directory: services/control-plane

      - name: Cargo audit - execution-plane
        run: |
          cargo install cargo-audit
          cargo audit
        working-directory: services/execution-plane

      - name: Cargo audit - agent
        run: cargo audit
        working-directory: services/agent

      - name: NPM audit - web (strict mode)
        run: npm audit --audit-level=moderate
        working-directory: apps/web

  security-sbom:
    name: 'Security: SBOM Generation'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install SBOM generation tools
        run: |
          echo "Installing CycloneDX tools..."
          go install github.com/CycloneDX/cyclonedx-go/cmd/cyclonedx-go@latest || true
          npm install -g @cyclonedx/npm || true

      - name: Generate SBOMs
        run: |
          ./scripts/generate-sbom.sh --all

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: sbom
          path: sbom/
          retention-days: 90

  # ============================================================================
  # STATUS CHECK (all jobs completed)
  # ============================================================================
  ci-status:
    name: 'CI Status Check'
    runs-on: ubuntu-latest
    needs:
      - go-build
      - go-test
      - go-lint
      - rust-build
      - rust-test
      - rust-fmt
      - rust-clippy
      - ts-check
      - ts-test
      - contracts-validate
      - security-gitleaks
      - security-dependencies
      - security-sbom
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.go-build.result }}" != "success" ]; then
            echo "❌ Go build failed"
            exit 1
          fi
          if [ "${{ needs.go-test.result }}" != "success" ]; then
            echo "❌ Go tests failed"
            exit 1
          fi
          if [ "${{ needs.go-lint.result }}" != "success" ]; then
            echo "❌ Go lint failed"
            exit 1
          fi
          if [ "${{ needs.rust-build.result }}" != "success" ]; then
            echo "❌ Rust build failed"
            exit 1
          fi
          if [ "${{ needs.rust-test.result }}" != "success" ]; then
            echo "❌ Rust tests failed"
            exit 1
          fi
          if [ "${{ needs.rust-fmt.result }}" != "success" ]; then
            echo "❌ Rust format check failed"
            exit 1
          fi
          if [ "${{ needs.rust-clippy.result }}" != "success" ]; then
            echo "❌ Rust clippy check failed"
            exit 1
          fi
          if [ "${{ needs.ts-check.result }}" != "success" ]; then
            echo "⚠️  TypeScript check failed (non-blocking in Phase 0)"
          fi
          if [ "${{ needs.contracts-validate.result }}" != "success" ]; then
            echo "❌ Contract validation failed"
            exit 1
          fi
          if [ "${{ needs.security-gitleaks.result }}" != "success" ]; then
            echo "❌ Secret scanning failed"
            exit 1
          fi
          echo "✅ All critical CI checks passed!"
